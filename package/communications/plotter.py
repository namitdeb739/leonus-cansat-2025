import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.ticker import MaxNLocator
import shutil
import os

from package.constants import (
    TelemetryFieldsCSVHeadings,
    TelemetryUnits,
)


class Plotter:
    LOGS_DIR = "logs/"
    TIME_FORMAT = "%H:%M:%S"
    NBINS = 10
    PLOTS_1_LINE = [
        TelemetryFieldsCSVHeadings.ALTITUDE.value,
        TelemetryFieldsCSVHeadings.TEMPERATURE.value,
        TelemetryFieldsCSVHeadings.PRESSURE.value,
        TelemetryFieldsCSVHeadings.VOLTAGE.value,
        TelemetryFieldsCSVHeadings.AUTO_GYRO_ROTATION_RATE.value,
    ]
    PLOTS_3_LINES = [
        [
            TelemetryFieldsCSVHeadings.GYRO_R.value,
            TelemetryFieldsCSVHeadings.GYRO_P.value,
            TelemetryFieldsCSVHeadings.GYRO_Y.value,
        ],
        [
            TelemetryFieldsCSVHeadings.ACCEL_R.value,
            TelemetryFieldsCSVHeadings.ACCEL_P.value,
            TelemetryFieldsCSVHeadings.ACCEL_Y.value,
        ],
        [
            TelemetryFieldsCSVHeadings.MAG_R.value,
            TelemetryFieldsCSVHeadings.MAG_P.value,
            TelemetryFieldsCSVHeadings.MAG_Y.value,
        ],
    ]

    def __init__(self, date_time: str, csv_file: str) -> None:
        self.csv_file = csv_file
        self.data = None
        self.log_dir = f"{Plotter.LOGS_DIR}{date_time}/"

    def __load_data(self, time_recieved_first_packet: str) -> bool:
        self.data = pd.read_csv(self.csv_file)
        if self.data.empty:
            print("No data found in the CSV file.")
            if os.path.exists(self.log_dir):
                shutil.rmtree(self.log_dir)
            return False

        return True

    def generate_plots(self, time_recieved_first_packet: str) -> None:
        if not self.__load_data(time_recieved_first_packet):
            return

        print("Generating plots...")
        for plot in Plotter.PLOTS_1_LINE:
            self.__plot_single_line(plot)

        for plot in Plotter.PLOTS_3_LINES:
            self.__plot_three_lines(plot)

    def __plot_single_line(self, plot: str) -> None:
        plt.figure()
        variable = " ".join(word.capitalize() for word in plot.split("_"))

        plt.plot(
            self.data[TelemetryFieldsCSVHeadings.MISSION_TIME.value],
            self.data[plot],
        )
        plt.title(f"{variable} over Time")
        plt.xlabel("")
        plt.ylabel(f"{variable}/{self.__get_unit(plot)}")
        plt.gca().xaxis.set_major_locator(MaxNLocator(nbins=self.NBINS))
        plt.gca().set_xticklabels([])
        plt.savefig(f"{self.log_dir}{variable.replace(' ', '')}.png")
        plt.close()

    def __plot_three_lines(self, plot: list) -> None:
        plt.figure()
        legend_labels = []
        variable = " ".join(
            word.capitalize() for word in plot[0].split("_")[:-1]
        )
        if variable == "Accel":
            variable = "Acceleration"
        elif variable == "Mag":
            variable = "Magnetometer"

        for line in plot:
            plt.plot(
                self.data[TelemetryFieldsCSVHeadings.MISSION_TIME.value],
                self.data[line],
            )
            if line.endswith("R"):
                legend_labels.append(f"{variable} Roll")
            elif line.endswith("P"):
                legend_labels.append(f"{variable} Pitch")
            elif line.endswith("Y"):
                legend_labels.append(f"{variable} Yaw")
            else:
                legend_labels.append(line)

        plt.title(f"{variable} over Time")
        plt.xlabel("")
        plt.ylabel(f"{variable}/{self.__get_unit(plot[0])}")
        plt.gca().xaxis.set_major_locator(MaxNLocator(nbins=self.NBINS))
        plt.gca().set_xticklabels([])
        plt.legend(legend_labels, loc="upper right")
        plt.savefig(f"{self.log_dir}{variable.replace(' ', '')}.png")
        plt.close()

    def __get_unit(self, field: str) -> str:
        if field not in [
            member.value for member in TelemetryFieldsCSVHeadings
        ]:
            return ""

        if field == TelemetryFieldsCSVHeadings.ALTITUDE.value:
            return TelemetryUnits.ALTITUDE.value
        elif field == TelemetryFieldsCSVHeadings.TEMPERATURE.value:
            return TelemetryUnits.TEMPERATURE.value
        elif field == TelemetryFieldsCSVHeadings.PRESSURE.value:
            return TelemetryUnits.PRESSURE.value
        elif field == TelemetryFieldsCSVHeadings.VOLTAGE.value:
            return TelemetryUnits.VOLTAGE.value
        elif field in [
            TelemetryFieldsCSVHeadings.GYRO_R.value,
            TelemetryFieldsCSVHeadings.GYRO_P.value,
            TelemetryFieldsCSVHeadings.GYRO_Y.value,
        ]:
            return TelemetryUnits.GYRO.value
        elif field in [
            TelemetryFieldsCSVHeadings.ACCEL_R.value,
            TelemetryFieldsCSVHeadings.ACCEL_P.value,
            TelemetryFieldsCSVHeadings.ACCEL_Y.value,
        ]:
            return TelemetryUnits.ACCELERATION.value
        elif field in [
            TelemetryFieldsCSVHeadings.MAG_R.value,
            TelemetryFieldsCSVHeadings.MAG_P.value,
            TelemetryFieldsCSVHeadings.MAG_Y.value,
        ]:
            return TelemetryUnits.MAGNETOMETER.value
        elif field == TelemetryFieldsCSVHeadings.AUTO_GYRO_ROTATION_RATE.value:
            return TelemetryUnits.GYRO_ROTATION_RATE.value

        return ""
